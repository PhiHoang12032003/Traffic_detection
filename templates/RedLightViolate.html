<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hệ Thống Phát Hiện Vi Phạm Vượt Đèn Đỏ</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/font-awesome.min.css"
    />
    <style>
      body {
        background-color: #f4f4f4;
        font-family: "Arial", sans-serif;
      }

      .header {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 20px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .video-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin: 20px 0;
      }

      .video-frame {
        position: relative;
        width: 100%;
        background-color: #000;
        border-radius: 8px;
        overflow: hidden;
      }

      .video-frame img {
        width: 100%;
        height: auto;
        display: block;
      }

      .upload-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin: 20px 0;
      }

      .upload-box {
        border: 2px dashed #dc3545;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.3s;
      }

      .upload-box:hover {
        background: #f0f0f0;
        border-color: #c82333;
      }

      .upload-box.dragover {
        background: #ffe6e6;
        border-color: #c82333;
      }

      .file-input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        overflow: hidden;
      }

      .upload-icon {
        font-size: 60px;
        color: #dc3545;
        margin-bottom: 20px;
      }

      .upload-text {
        color: #666;
        font-size: 18px;
        margin-bottom: 10px;
      }

      .upload-hint {
        color: #999;
        font-size: 14px;
      }

      .btn-analyze {
        background: #dc3545;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-size: 16px;
        margin-top: 20px;
        transition: all 0.3s;
        display: none;
      }

      .btn-analyze:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 20px;
      }

      .stats-icon {
        font-size: 40px;
        margin-bottom: 10px;
      }

      .stats-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
      }

      .stats-label {
        color: #666;
        font-size: 14px;
      }

      .violation-alert {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 15px 25px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: none;
        animation: slideIn 0.3s;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .traffic-light-status {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: bold;
        margin: 10px 0;
      }

      .light-red {
        background: #dc3545;
        color: white;
      }

      .light-green {
        background: #28a745;
        color: white;
      }

      .light-yellow {
        background: #ffc107;
        color: #333;
      }

      .progress-section {
        display: none;
        margin: 20px 0;
      }

      .nav-buttons {
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="container">
        <h1 class="text-center">
          <i class="fas fa-traffic-light"></i>
          Hệ Thống Phát Hiện Vi Phạm Vượt Đèn Đỏ
        </h1>
        <p class="text-center mb-0">
          Sử dụng AI để phát hiện và ghi nhận vi phạm giao thông
        </p>
      </div>
    </div>

    <!-- Navigation -->
    <div class="container nav-buttons">
      <a href="/" class="btn btn-secondary">
        <i class="fas fa-home"></i> Trang Chủ
      </a>
      <a href="/Hethongcamera1" class="btn btn-secondary">
        <i class="fas fa-road"></i> Vi Phạm Làn Đường
      </a>
      <a href="/Hethongcamera2" class="btn btn-secondary">
        <i class="fas fa-hard-hat"></i> Vi Phạm Mũ Bảo Hiểm
      </a>
    </div>

    <div class="container">
      <div class="row">
        <!-- Upload Section -->
        <div class="col-lg-12">
          <div class="upload-section">
            <h3 class="mb-4">
              <i class="fas fa-upload"></i> Tải Video Lên Để Phân Tích
            </h3>

            <!-- Detection Method Selection -->
            <div class="mb-4">
              <h5><i class="fas fa-cogs"></i> Phương Pháp Phát Hiện</h5>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  name="detectionMethod"
                  id="basicMethod"
                  value="original"
                  checked
                />
                <label class="form-check-label" for="basicMethod">
                  <i class="fas fa-eye"></i> Cơ Bản (Nhanh)
                </label>
              </div>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  name="detectionMethod"
                  id="advancedMethod"
                  value="advanced"
                />
                <label class="form-check-label" for="advancedMethod">
                  <i class="fas fa-brain"></i> Nâng Cao (AI + Biển Số)
                </label>
              </div>
              <small class="form-text text-muted">
                Phương pháp nâng cao sử dụng YOLO + nhận diện biển số xe vi phạm
              </small>
            </div>

            <div class="upload-box" id="uploadBox">
              <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <div class="upload-text">
                Kéo thả video vào đây hoặc click để chọn file
              </div>
              <div class="upload-hint">
                Hỗ trợ: MP4, AVI, MOV, MKV (Tối đa 500MB)
              </div>
              <input
                type="file"
                id="fileInput"
                class="file-input"
                accept=".mp4,.avi,.mov,.mkv,.webm,video/*"
              />
            </div>

            <!-- Alternative upload button -->
            <div class="text-center mt-3">
              <button
                type="button"
                class="btn btn-outline-danger"
                id="uploadBtnAlt"
              >
                <i class="fas fa-folder-open"></i> Chọn Video
              </button>
            </div>

            <!-- Debug: Visible file input -->
            <div class="mt-3 p-3 bg-warning">
              <p><strong>Debug Mode:</strong> File input hiển thị để test</p>
              <input type="file" id="debugFileInput" accept="video/*" />
            </div>

            <div id="fileInfo" style="display: none" class="mt-3">
              <div class="alert alert-info">
                <i class="fas fa-file-video"></i>
                File đã chọn: <span id="fileName"></span>
                <button
                  class="btn btn-sm btn-danger float-right"
                  id="clearFile"
                >
                  <i class="fas fa-times"></i> Xóa
                </button>
              </div>
            </div>

            <div class="progress-section" id="progressSection">
              <div class="progress">
                <div
                  class="progress-bar progress-bar-striped progress-bar-animated"
                  id="uploadProgress"
                  role="progressbar"
                  style="width: 0%"
                >
                  0%
                </div>
              </div>
            </div>

            <div class="text-center">
              <button
                class="btn btn-primary"
                id="processBtn"
                style="display: none"
              >
                <i class="fas fa-cog"></i> Xử Lý và Xuất Video
              </button>
            </div>

            <!-- Processing Status -->
            <div id="processingStatus" style="display: none" class="mt-3">
              <div class="alert alert-info">
                <div class="d-flex align-items-center">
                  <div
                    class="spinner-border spinner-border-sm mr-3"
                    role="status"
                  >
                    <span class="sr-only">Loading...</span>
                  </div>
                  <span id="processingMessage">Đang xử lý video...</span>
                </div>
                <div class="progress mt-2">
                  <div
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    role="progressbar"
                    style="width: 100%"
                  ></div>
                </div>
              </div>
            </div>

            <!-- Download Section -->
            <div id="downloadSection" style="display: none" class="mt-3">
              <div class="alert alert-success">
                <h5><i class="fas fa-check-circle"></i> Xử Lý Hoàn Thành!</h5>
                <p id="processingStats"></p>
                <button class="btn btn-success" id="downloadBtn">
                  <i class="fas fa-download"></i> Tải Video Đã Xử Lý
                </button>
                <button class="btn btn-secondary ml-2" id="processNewBtn">
                  <i class="fas fa-upload"></i> Xử Lý Video Khác
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Processing Info -->
        <div class="col-lg-8">
          <div class="video-container">
            <h3 class="mb-3">
              <i class="fas fa-cogs"></i> Xử Lý Video Vi Phạm Đèn Đỏ
            </h3>
            <div class="text-center p-5">
              <i class="fas fa-traffic-light fa-5x text-danger mb-3"></i>
              <h5>Hệ Thống Phát Hiện Vi Phạm Vượt Đèn Đỏ</h5>
              <p class="text-muted">
                Sử dụng AI để phát hiện xe cộ vượt đèn đỏ và nhận diện biển số
              </p>
              <div class="mt-4">
                <div class="row">
                  <div class="col-md-4">
                    <div class="text-center p-3">
                      <i class="fas fa-eye fa-2x text-primary mb-2"></i>
                      <h6>Phát Hiện Đèn Giao Thông</h6>
                      <small class="text-muted">Sử dụng YOLO + HSV</small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-3">
                      <i class="fas fa-car fa-2x text-success mb-2"></i>
                      <h6>Theo Dõi Xe Cộ</h6>
                      <small class="text-muted"
                        >Phát hiện vi phạm realtime</small
                      >
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-3">
                      <i class="fas fa-id-card fa-2x text-warning mb-2"></i>
                      <h6>Nhận Diện Biển Số</h6>
                      <small class="text-muted">OCR cho biển số Việt Nam</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics -->
        <div class="col-lg-4">
          <h3 class="mb-3">
            <i class="fas fa-chart-bar"></i> Thống Kê Vi Phạm
          </h3>

          <div class="stats-card">
            <div class="stats-icon text-danger">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stats-value" id="totalViolations">0</div>
            <div class="stats-label">Tổng Vi Phạm</div>
          </div>

          <div class="stats-card">
            <div class="stats-icon text-primary">
              <i class="fas fa-car"></i>
            </div>
            <div class="stats-value" id="carViolations">0</div>
            <div class="stats-label">Ô Tô Vi Phạm</div>
          </div>

          <div class="stats-card">
            <div class="stats-icon text-success">
              <i class="fas fa-motorcycle"></i>
            </div>
            <div class="stats-value" id="motorViolations">0</div>
            <div class="stats-label">Xe Máy Vi Phạm</div>
          </div>

          <button class="btn btn-info btn-block mt-3" id="exportBtn">
            <i class="fas fa-download"></i> Xuất Báo Cáo
          </button>
        </div>
      </div>
    </div>

    <!-- Violation Alert -->
    <div class="violation-alert" id="violationAlert">
      <i class="fas fa-exclamation-circle"></i>
      Phát hiện vi phạm vượt đèn đỏ!
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function () {
        let selectedFile = null;
        let isAnalyzing = false;

        // Debug - check if file input exists
        console.log(
          "File input element:",
          document.getElementById("fileInput")
        );

        // Make upload box clickable
        document
          .getElementById("uploadBox")
          .addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Upload box clicked (native)");
            const fileInput = document.getElementById("fileInput");
            if (fileInput) {
              fileInput.click();
            } else {
              console.error("File input not found!");
            }
          });

        // Also add jQuery handler as backup
        $("#uploadBox").on("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("Upload box clicked (jQuery)");
          $("#fileInput").trigger("click");
        });

        // Alternative button click
        $("#uploadBtnAlt").on("click", function () {
          console.log("Alternative button clicked");
          $("#fileInput").click();
        });

        // Debug file input
        $("#debugFileInput").on("change", function (e) {
          console.log("Debug file input changed:", e.target.files);
          const file = e.target.files[0];
          if (file) {
            handleFileSelect(file);
          }
        });

        // File input change
        $("#fileInput").change(function (e) {
          console.log("File input changed:", e.target.files);
          const file = e.target.files[0];
          if (file) {
            handleFileSelect(file);
          } else {
            console.log("No file selected");
          }
        });

        // Drag and drop
        $("#uploadBox").on("dragover", function (e) {
          e.preventDefault();
          $(this).addClass("dragover");
        });

        $("#uploadBox").on("dragleave", function (e) {
          e.preventDefault();
          $(this).removeClass("dragover");
        });

        $("#uploadBox").on("drop", function (e) {
          e.preventDefault();
          $(this).removeClass("dragover");

          const files = e.originalEvent.dataTransfer.files;
          if (files.length > 0) {
            handleFileSelect(files[0]);
          }
        });

        // Handle file selection
        function handleFileSelect(file) {
          // Check file extension instead of MIME type for better compatibility
          const fileName = file.name.toLowerCase();
          const allowedExtensions = [".mp4", ".avi", ".mov", ".mkv", ".webm"];
          const fileExtension = fileName.substring(fileName.lastIndexOf("."));

          console.log(
            "File selected:",
            file.name,
            "Type:",
            file.type,
            "Extension:",
            fileExtension
          );

          if (!allowedExtensions.includes(fileExtension)) {
            alert("Vui lòng chọn file video hợp lệ (MP4, AVI, MOV, MKV)");
            return;
          }

          if (file.size > 500 * 1024 * 1024) {
            alert("File quá lớn. Vui lòng chọn file nhỏ hơn 500MB");
            return;
          }

          selectedFile = file;
          $("#fileName").text(file.name);
          $("#fileInfo").show();
          $("#processBtn").show();
        }

        // Clear file
        $("#clearFile").click(function () {
          selectedFile = null;
          $("#fileInput").val("");
          $("#fileInfo").hide();
          $("#processBtn").hide();
          $("#progressSection").hide();
          $("#processingStatus").hide();
          $("#downloadSection").hide();
        });

        // Upload video for processing (simplified)
        function uploadVideoForProcessing() {
          if (!selectedFile) return false;

          const formData = new FormData();
          formData.append("video", selectedFile);

          // Get selected detection method
          const detectionMethod = $(
            'input[name="detectionMethod"]:checked'
          ).val();
          formData.append("detection_method", detectionMethod);

          // Show progress
          $("#progressSection").show();

          return $.ajax({
            url: "/upload_video",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            xhr: function () {
              const xhr = new window.XMLHttpRequest();
              xhr.upload.addEventListener(
                "progress",
                function (evt) {
                  if (evt.lengthComputable) {
                    const percentComplete = Math.round(
                      (evt.loaded / evt.total) * 100
                    );
                    $("#uploadProgress")
                      .css("width", percentComplete + "%")
                      .text(percentComplete + "%");
                  }
                },
                false
              );
              return xhr;
            },
          });
        }

        // Load real violation statistics
        function loadViolationStats() {
          $.ajax({
            url: "/api/red_light_violations",
            type: "GET",
            success: function (data) {
              $("#totalViolations").text(data.total_violations || 0);
              // For now, split violations between cars and motorcycles roughly
              const carViolations = Math.floor(
                (data.total_violations || 0) * 0.6
              );
              const motorViolations =
                (data.total_violations || 0) - carViolations;
              $("#carViolations").text(carViolations);
              $("#motorViolations").text(motorViolations);

              // Show detection method
              const method = data.detection_method || "Basic";
              console.log("Current detection method:", method);
            },
            error: function () {
              console.log("Could not load violation statistics");
            },
          });
        }

        // Check for violations periodically
        function checkForViolations() {
          // Load initial stats
          loadViolationStats();

          // Refresh stats every 5 seconds
          setInterval(function () {
            loadViolationStats();
          }, 5000);

          // Simulate real-time updates (for demo)
          setInterval(function () {
            // Random light change simulation
            if (Math.random() < 0.05) {
              const lights = ["red", "yellow", "green"];
              const lightTexts = ["Đèn Đỏ", "Đèn Vàng", "Đèn Xanh"];
              const lightClasses = ["light-red", "light-yellow", "light-green"];
              const randomIndex = Math.floor(Math.random() * 3);

              $("#lightStatus")
                .removeClass("light-red light-yellow light-green")
                .addClass(lightClasses[randomIndex])
                .html(
                  '<i class="fas fa-circle"></i> ' + lightTexts[randomIndex]
                );
            }
          }, 3000);
        }

        // Start checking for violations
        checkForViolations();

        // Process button click - Generate output video
        $("#processBtn").click(function () {
          if (!selectedFile) return;

          const $btn = $(this);
          $btn
            .prop("disabled", true)
            .html('<i class="fas fa-spinner fa-spin"></i> Đang tải lên...');

          // First upload the video
          uploadVideoForProcessing()
            .done(function (uploadResponse) {
              if (uploadResponse.success) {
                $btn.html(
                  '<i class="fas fa-cog fa-spin"></i> Đang xử lý video...'
                );
                $("#processingStatus").show();
                $("#downloadSection").hide();
                $("#progressSection").hide();

                // Start processing
                $.ajax({
                  url: "/process_red_light_video",
                  type: "POST",
                  success: function (response) {
                    if (response.success) {
                      $("#processingMessage").text(response.message);

                      // Start checking processing status
                      checkProcessingStatus(response.job_id);
                    } else {
                      alert("Lỗi: " + (response.error || "Unknown error"));
                      $btn
                        .prop("disabled", false)
                        .html('<i class="fas fa-cog"></i> Xử Lý và Xuất Video');
                      $("#processingStatus").hide();
                    }
                  },
                  error: function (xhr) {
                    let errorMsg = "Lỗi khi xử lý video";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                      errorMsg = xhr.responseJSON.error;
                    }
                    alert(errorMsg);
                    $btn
                      .prop("disabled", false)
                      .html('<i class="fas fa-cog"></i> Xử Lý và Xuất Video');
                    $("#processingStatus").hide();
                  },
                });
              } else {
                alert(
                  "Lỗi khi tải video: " +
                    (uploadResponse.error || "Unknown error")
                );
                $btn
                  .prop("disabled", false)
                  .html('<i class="fas fa-cog"></i> Xử Lý và Xuất Video');
              }
            })
            .fail(function (xhr) {
              alert(
                "Lỗi khi tải video: " +
                  (xhr.responseJSON?.error || "Network error")
              );
              $btn
                .prop("disabled", false)
                .html('<i class="fas fa-cog"></i> Xử Lý và Xuất Video');
            });
        });

        // Check processing status
        function checkProcessingStatus(jobId) {
          const checkStatus = () => {
            $.ajax({
              url: "/api/red_light_processing_status",
              type: "GET",
              success: function (data) {
                if (data.status === "completed") {
                  $("#processingStatus").hide();
                  $("#downloadSection").show();

                  // Display statistics
                  const stats = data.stats || {};
                  let statsText = `Tổng vi phạm: ${
                    stats.total_violations || 0
                  }. `;
                  if (stats.processing_time) {
                    statsText += `Thời gian xử lý: ${stats.processing_time.toFixed(
                      1
                    )} giây.`;
                  }
                  $("#processingStats").text(statsText);

                  // Set up download button
                  $("#downloadBtn")
                    .off("click")
                    .on("click", function () {
                      window.location.href = data.download_url;
                    });

                  $("#processBtn")
                    .prop("disabled", false)
                    .html('<i class="fas fa-cog"></i> Xử Lý và Xuất Video');
                } else if (data.status === "error") {
                  $("#processingStatus").hide();
                  alert("Lỗi xử lý: " + (data.error || "Unknown error"));
                  $("#processBtn")
                    .prop("disabled", false)
                    .html('<i class="fas fa-cog"></i> Xử Lý và Xuất Video');
                } else if (data.status === "processing") {
                  $("#processingMessage").text(
                    data.message || "Đang xử lý video..."
                  );
                  // Continue checking
                  setTimeout(checkStatus, 2000);
                } else {
                  // Unknown status, stop checking
                  $("#processingStatus").hide();
                  $("#processBtn")
                    .prop("disabled", false)
                    .html('<i class="fas fa-cog"></i> Xử Lý và Xuất Video');
                }
              },
              error: function () {
                // Error checking status, stop trying
                $("#processingStatus").hide();
                $("#processBtn")
                  .prop("disabled", false)
                  .html('<i class="fas fa-cog"></i> Xử Lý và Xuất Video');
              },
            });
          };

          // Start checking immediately
          checkStatus();
        }

        // Process new video button
        $("#processNewBtn").click(function () {
          $("#downloadSection").hide();
          $("#fileInfo").hide();
          $("#processBtn").hide();
          selectedFile = null;
          $("#fileInput").val("");
        });

        // Export button
        $("#exportBtn").click(function () {
          alert("Tính năng xuất báo cáo đang được phát triển!");
        });
      });
    </script>
  </body>
</html>
